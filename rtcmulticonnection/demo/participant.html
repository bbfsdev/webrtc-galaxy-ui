<!DOCTYPE html>
<html>
	<head>
		<title>Participant</title>
		<script src="/RTCMultiConnection-v1.8.js" type="text/javascript"></script>
        <link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
	</head>
	<body>
		<button id="js-start-broadcasting-button">Start broadcasting</button>
        <span id="js-status-container"></span>
        <p><video autoplay></video></p>

		<script>
			//window.skipRTCMultiConnectionLogs = true;

			var video = document.querySelector('video');
			var stream;
			var size = {width: 320, height: 240};
			var sessions = {};

			var channelid = 'BB-Group-Video';

			var connection = new RTCMultiConnection(channelid);
			connection.sessionid = 'virtual-group';
            connection.isInitiator = false;
			connection.autoReDialOnFailure = true;
			connection.media.max(size.width, size.height);

            connection.onNewSession = function(session) {
                console.log("New session: ", session);
                session.session = {video: true};
                if (sessions[session.sessionid]) return;
                sessions[session.sessionid] = session;
                session.join();
            }

			// On getting local or remote media stream
			connection.onstream = function(e) {
                console.log("New stream: ", e)
                video.src = URL.createObjectURL(e.stream)
				video.play();
				stream = e.stream;
			};

            connection.onleave = function(e) {
                console.log("User left", e);
                if (e.entireSessionClosed) {
                    var statusContainer = document.querySelector('#js-status-container');
                    statusContainer.innerHTML = "The initiator has left";
                }
            };

            connection.onSessionClosed = function(e) {
                console.log("Entire session closed: ", e);
            };

			// Connect to existing session
			document.querySelector('#js-start-broadcasting-button').onclick = function() {
				connection.connect();
			};

			window.onbeforeunload = connection.close;
		</script>

	</body>
</html>


<!DOCTYPE html>
<html>
	<head>
		<title>RTCMultiConnection -- PARTICIPANT</title>
		<script src="/RTCMultiConnection-v1.8.js" type="text/javascript"></script>
	</head>
	<body>
		<button id="small-screen">Small screen</button>
		<button id="big-screen">Big screen</button>
        <p><video autoplay></video></p>

		<script>
			//window.skipRTCMultiConnectionLogs = true;
			var stream;
			var sessions = {};
			var channelid = 'BB-Group-Video';
			var video = document.querySelector('video');
            var connection;
            var interval;

            function initConnection() {
                if (interval)
                    window.clearInterval(interval);
                if (connection)
                    connection.close();

                connection = new RTCMultiConnection(channelid);
                connection.sessionid = 'small-room';
                connection.autoReDialOnFailure = true;

                connection.onNewSession = function(session) {
                    console.log('New session!', session)
                    if (sessions[session.sessionid]) return;
                    sessions[session.sessionid] = session;
                    console.log("Joining session...")
                    session.join({oneway: true});
                }

                // on getting local or remote media stream
                connection.onstream = function(e) {
                    console.log("New stream!", e)
                    video.src = URL.createObjectURL(e.stream)
                    video.play();
                    stream = e.stream;
                };

                connection.onleave = function(e) {
                    if (!!stream) {
                        video.src = null;
                        stream.stop('remote');
                        stream = null;
                    }
                    console.log('Leaving room ', connection.sessionid);
                    sessions[connection.sessionid] = undefined;
                    interval = setInterval(initConnection, 5000);
                }

                connection.onSessionClosed = function(e) {
                    console.log("Session closed,", e);
                }

                connection.onerror = function(e) {
                    console.log("Error occured,", e);
                }

                connection.onclose = function(e) {
                    console.log("Connection closed.");
                }

                // setup signalling channel
                connection.connect();
            }

			function restartMedia(connection, message) {
                console.log("Restarting media...")
				if (!!stream) {
					video.src = null;
					stream.stop('local');
					stream = null;
				}
				connection.sendCustomMessage(message);
			}

			document.querySelector('#small-screen').onclick = function() {
				restartMedia(connection, 'small-screen');
			};
			document.querySelector('#big-screen').onclick = function() {
				restartMedia(connection, 'big-screen');
			};

            initConnection();
		</script>

	</body>
</html>

